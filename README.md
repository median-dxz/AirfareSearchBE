# AirfareSearchBE
AirfareSearch Backend Components

# 模块说明

- rpc: rpc服务器模块，对外提供服务的模块，入口点，多线程处理请求
- search-serivce: 主服务模块，提供搜索逻辑，处理rpc传入的请求
- database: 数据库相关接口代码和业务代码，作为中间层运行，为主服务提供数据库无关抽象
- data-updater: 数据更新服务，数据更新相关逻辑
- data-generator: 模拟数据生成

模块之间的依赖关系如下：

- 在`rpc`中起一个服务器，监听客户端请求和数据更新请求，本身作为一个`Controller`。
  - 如果请求来自客户端: 将请求转发给`search-service`，竞争线程处理请求，将结果返回给客户端。
  - 如果请求来自数据更新服务: 将请求转发给`data-updater`，将结果返回给数据更新服务。

- `search-service` 和 `data-updater` 都会调用 `database` 进行数据库内容的持久化，同时`data-updator`通过`data-generator`生成模拟数据。

# 搜索模块

实现思路：

数据库部分已针对搜索过程在相应位置建立主键索引和列索引

- 对于每段查找的航程：
  - 根据`departure`和`arrival`找到所有可用的航班
  - 同时通过join操作查找对应的余座和票价信息并进行整合
  - 上述信息全部加载进内存
  
- 首先进行初步筛选，排除日期不合法和余座数量不合法的结果

- 然后通过广度优先搜索进行状态转移

  - 将所有初筛后的第一段航班的结果放入搜索队列
  - 每次取出一个结果进行状态转移
  - 使用carrier作为键，在数据库查找对应的规则列表
    - 这一步可以考虑一次性在内存中载入所有的规则，然后在程序中建立map，而不是每次搜索都进行数据库查询
  - 按seqNo从小到大遍历，判断规则是否匹配
  - 若匹配或者没有任何匹配，更新当前结果
  - 如果行程数=请求行程数则加入结果集
  - 否则遍历下一段行程的可用航班，匹配`nextCarrier`，并加入搜索队列

- 最后整理结果，进行排序和数量筛选

# 数据生成器

规模：
  - 航班数量和运价和余座信息：1e5
  - 运价规则：1e5

为了方便演示，降低随机数据的导入时间同时保持一定数据规模，生成器内做如下特殊处理：
  - 城市生成的权重全部集中在热门城市中
  - 生成的航班日期集中在`2024.01.01`-`2024.01.10`
  - 所有的运价规则中，`departure`字段为空，意味着出站规则一定会匹配成功
  - 优先生成非空入站规则（`arrival`字段非空）
  - 优先生成非空下段承运人规则（`nextCarrier`字段非空）

# 未实现

数据更新器模块，同时搜索服务也没有对应的更新标志检查来标记此次搜索是否使用了脏数据